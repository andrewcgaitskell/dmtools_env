FROM ubuntu:20.04

ARG BUILD_ENV_USERNAME
ARG BUILD_ENV_UID
ARG BUILD_ENV_GID 
ARG BUILD_ENV_GROUPNAME

ENV ENV_USERNAME=$BUILD_ENV_USERNAME
ENV ENV_USER_UID=$BUILD_ENV_UID
ENV ENV_USER_GID=$BUILD_ENV_GID 
ENV ENV_USER_GROUPNAME=$BUILD_ENV_GROUPNAME

# Install necessary dependencies
RUN apt-get update && apt-get install -y \
    curl \
    tar \
    git \
    sudo \
    && rm -rf /var/lib/apt/lists/*


RUN apt-get -y install unzip

# Download and install the GitHub Actions Runner
RUN curl -o actions-runner-linux-x64-2.300.2.tar.gz -L https://github.com/actions/runner/releases/download/v2.300.2/actions-runner-linux-x64-2.300.2.tar.gz && \
    tar xzf actions-runner-linux-x64-2.300.2.tar.gz && \
    rm -f actions-runner-linux-x64-2.300.2.tar.gz

WORKDIR /workdir

RUN echo groupadd --gid ${ENV_USER_GID} ${ENV_USER_GROUPNAME}
RUN groupadd --gid ${ENV_USER_GID} ${ENV_USER_GROUPNAME}
RUN echo useradd --uid ${ENV_USER_UID} --gid ${ENV_USER_GID} -m ${ENV_USERNAME}
RUN useradd --uid ${ENV_USER_UID} --gid ${ENV_USER_GID} -m ${ENV_USERNAME}

RUN chown -R ${ENV_USER_UID}:${ENV_USER_GID} /workdir

# Create a user for the GitHub runner
# RUN useradd -m runner && echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to the runner user
USER ${ENV_USER_UID}:${ENV_USER_GID}
WORKDIR /workdir

# Set environment variables
ENV RUNNER_NAME="podman-runner"
## ENV RUNNER_WORKDIR="_work"
ENV RUNNER_WORKDIR="_work"

# Copy entrypoint script
COPY entry_point.sh .

# Make the entrypoint script executable
RUN chmod +x entry_point.sh

# Set the entrypoint to the script
ENTRYPOINT ["./entry_point.sh"]
